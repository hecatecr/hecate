name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest
      
      - name: Check formatting
        run: crystal tool format --check

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [core, lex]
    
    name: Test hecate-${{ matrix.shard }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest
      
      - name: Install just
        uses: extractions/setup-just@v2
      
      - name: Cache shards
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/shards
            lib
            shards/*/lib
          key: ${{ runner.os }}-shards-latest-${{ matrix.shard }}-${{ hashFiles('shard.yml', 'shard.dev.yml', '**/shard.yml') }}
          restore-keys: |
            ${{ runner.os }}-shards-latest-${{ matrix.shard }}-
            ${{ runner.os }}-shards-latest-
      
      - name: Install dependencies
        run: just install
      
      - name: Run tests for specific shard
        run: just test-shard ${{ matrix.shard }}
      
      - name: Build shard
        run: |
          export SHARDS_OVERRIDE=shard.dev.yml
          crystal build --no-codegen shards/hecate-${{ matrix.shard }}/src/hecate-${{ matrix.shard }}.cr

  # Test the monorepo integration
  integration:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest
      
      - name: Install just
        uses: extractions/setup-just@v2
      
      - name: Cache shards
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/shards
            lib
          key: ${{ runner.os }}-shards-latest-integration-${{ hashFiles('shard.yml', 'shard.dev.yml') }}
          restore-keys: |
            ${{ runner.os }}-shards-latest-integration-
      
      - name: Install all dependencies
        run: just install
      
      - name: Run all tests from root
        run: just test
      
      - name: Check examples build
        run: |
          just example-json
          just example-js
          just example-dynamic

  docs:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Crystal
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest
      
      - name: Install just
        uses: extractions/setup-just@v2
      
      - name: Install dependencies
        run: |
          cd shards/hecate-core && shards install
          cd ../hecate-lex && shards install
      
      - name: Generate documentation
        run: just docs